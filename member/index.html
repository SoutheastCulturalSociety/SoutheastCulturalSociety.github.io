<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SCS Member ID Generator</title>

  <link rel="icon" type="image/png" href="../assets/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background: linear-gradient(135deg,#fff1e6,#f5e0dc); color:#4d1a00; min-height:100vh; text-align:center; padding-bottom:50px; }
    header { background: rgba(128,0,0,0.85); color:white; padding:1rem; }
    header img.logo { width:90px; height:auto; display:block; margin:0 auto 10px auto; }
    header h1 { font-size:2rem; margin-bottom:5px; }
    header p { font-weight:500; margin-bottom:10px; }
    nav a { color:#ffd700; margin:0 12px; text-decoration:none; font-weight:600; }
    nav a:hover { text-decoration:underline; }
    section { padding:40px 15px; }
    h2 { font-size:1.8rem; margin-bottom:20px; color:maroon; }
    input, button { padding:10px 15px; margin:8px 5px; border-radius:8px; border:1px solid #b22a2a; font-size:1rem; }
    button { background:gold; color:maroon; font-weight:600; cursor:pointer; transition: all 0.3s; }
    button:hover { background:#ffd94d; transform:scale(1.05); }
    #preview { margin:20px auto; width:340px; height:215px; border:2px solid #b22a2a; border-radius:10px; background:#fff8f0; position:relative; display:none; padding:15px; }
    #preview img.logo-preview { width:60px; height:auto; position:absolute; top:15px; right:15px; }
    #preview div.info { text-align:left; margin-top:55px; font-size:12px; line-height:1.5; }
    #loader { display:none; margin:20px auto; border:4px solid #f3f3f3; border-top:4px solid #b22a2a; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    footer { background:#8b0000; color:#fffaf0; text-align:center; padding:15px 0; font-size:0.95rem; position:relative; margin-top:40px; }
    @media (max-width:768px) { input, button { width:80%; } #preview { width:280px; height:180px; } }
  </style>
</head>
<body>

<header>
  <img src="../assets/logo.png" alt="SCS Logo" class="logo">
  <h1>Southeast Cultural Society</h1>
  <p>Since 2010</p>
  <nav>
    <a href="#member-id">Generate ID Card</a>
    <a href="https://southeastculturalsociety.github.io" target="_blank">Home</a>
  </nav>
</header>

<section id="member-id">
  <h2>Member ID Card Generator</h2>
  <p>Enter your Student ID to generate your ID card.</p>
  <input type="text" id="studentId" placeholder="Enter Student ID">
  <button id="generateBtn" onclick="fetchID()">Generate ID Card</button>
  <div id="loader"></div>
  <div style="margin-top:10px;">
    <button id="downloadBtn" style="display:none;" onclick="downloadID()">Download PDF</button>
    <button id="regenBtn" style="display:none;" onclick="reGenerate()">Re-Generate</button>
  </div>

  <div id="preview">
    <img src="../assets/logo.png" class="logo-preview" alt="Logo">
    <div class="info" id="previewInfo"></div>
  </div>
</section>

<footer>
  &copy; 2010–2025 Southeast Cultural Society
</footer>

<script>
let currentData = null;

document.getElementById('studentId').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    fetchID();
  }
});

async function fetchID() {
  const studentId = document.getElementById('studentId').value.trim();
  if (!studentId) return alert("Please enter your Student ID.");

  const loader = document.getElementById('loader');
  loader.style.display = 'block';
  document.getElementById('downloadBtn').style.display = 'none';
  document.getElementById('regenBtn').style.display = 'none';
  document.getElementById('preview').style.display = 'none';
  document.getElementById('generateBtn').style.display = 'none';

  const apiUrl = "https://script.google.com/macros/s/AKfycbzXNMskZbQ1gMRPdw5is8b5dEgLO0P7p5YcNwKgFX3YjgLKo6sqI5Ukt4MkVYxmC1Fc/exec?id=" + encodeURIComponent(studentId);

  try {
    const res = await fetch(apiUrl);
    const result = await res.json();
    loader.style.display = 'none';

    if (!result.success || !result.data) {
      document.getElementById('generateBtn').style.display = 'inline-block';
      return alert(result.message || "Student ID not found.");
    }

    currentData = result.data;

    // ✅ Robust Active Year handling (supports array or string)
    let activeYears = currentData['Active Year'] || currentData['ACTIVEYEAR'] || currentData['ACTIVE YEAR'];
    if (Array.isArray(activeYears)) {
      activeYears = activeYears.join(', ');
    } else if (typeof activeYears === 'string') {
      activeYears = activeYears.split(/[,;]+/).map(y => y.trim()).filter(y => y).join(', ');
    }
    currentData['Active Year'] = activeYears || '—';

    const filteredData = { ...currentData };
    delete filteredData['SL'];
    delete filteredData['MAIL ID'];
    delete filteredData['WhatsApp no'];

    const preview = document.getElementById('preview');
    const previewInfo = document.getElementById('previewInfo');

    previewInfo.innerHTML = `
      <strong>Name:</strong> ${filteredData.NAME}<br>
      <strong>Student ID:</strong> ${filteredData['STUDENT ID']}<br>
      <strong>Department & Batch:</strong> ${filteredData.DEPARTMENT} - ${filteredData.BATCH}<br>
      <strong>Active Year:</strong> ${filteredData['Active Year']}
    `;
    preview.style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'inline-block';
    document.getElementById('regenBtn').style.display = 'inline-block';

  } catch (error) {
    loader.style.display = 'none';
    document.getElementById('generateBtn').style.display = 'inline-block';
    console.error(error);
    alert("Error fetching data. Please try again later.");
  }
}

function toDataURL(url, callback) {
  const img = new Image();
  img.crossOrigin = 'Anonymous';
  img.src = url;
  img.onload = function() {
    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const dataURL = canvas.toDataURL('image/png');
    callback(dataURL, img.width, img.height);
  };
}

function downloadID() {
  if (!currentData) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: [85.6, 54]
  });

  doc.setFillColor(255, 248, 240);
  doc.rect(0, 0, 85.6, 54, 'F');

  toDataURL('../assets/logo.png', function(logoBase64, w, h) {
    const maxWidth = 13;
    const aspect = h / w;
    const finalHeight = maxWidth * aspect;
    const xPos = 85.6 - maxWidth - 5;
    const yPos = 5;

    doc.addImage(logoBase64, 'PNG', xPos, yPos, maxWidth, finalHeight);

    const filteredData = { ...currentData };
    delete filteredData['SL'];
    delete filteredData['MAIL ID'];
    delete filteredData['WhatsApp no'];

    let y = 22;
    doc.setFontSize(8);
    doc.setTextColor(0, 0, 0);
    doc.text(`Name: ${filteredData.NAME}`, 6, y); y += 6;
    doc.text(`Student ID: ${filteredData['STUDENT ID']}`, 6, y); y += 6;
    doc.text(`Dept & Batch: ${filteredData.DEPARTMENT} - ${filteredData.BATCH}`, 6, y); y += 6;
    if (filteredData['Active Year']) { doc.text(`Active Year: ${filteredData['Active Year']}`, 6, y); }

    doc.save(`${filteredData.NAME}_SCS_ID.pdf`);
  });
}

function reGenerate() {
  document.getElementById('studentId').value = '';
  document.getElementById('preview').style.display = 'none';
  document.getElementById('downloadBtn').style.display = 'none';
  document.getElementById('regenBtn').style.display = 'none';
  document.getElementById('generateBtn').style.display = 'inline-block';
  currentData = null;
  document.getElementById('studentId').focus();
}
</script>

</body>
</html>
